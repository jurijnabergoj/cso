Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu22.04

%environment
    export LC_ALL=C
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH="/opt/conda/bin:$PATH"
    export CUDA_HOME=/usr/local/cuda
    export MAX_JOBS=1

%post
    export DEBIAN_FRONTEND=noninteractive
    export MAMBA_ROOT_PREFIX=/opt/conda


    apt update && apt install -y \
        build-essential \
        cmake \
        git \
        curl \
        ffmpeg \
        libgl1 \
        libglib2.0-0 \
        ca-certificates

    # micromamba
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
    mkdir -p /opt/conda
    mv bin/micromamba /usr/local/bin/

    micromamba create -y -n geco2 -c pytorch -c nvidia -c conda-forge \
        python=3.10 \
        pytorch=2.7.1 \
        torchvision=0.22.1 \
        torchaudio=2.7.1 \
        pytorch-cuda=11.8

        pip install torch==2.7.1 ... --index-url https://download.pytorch.org/whl/cu126

    # clone GECO2
    mkdir -p /workspace
    cd /workspace
    git clone https://github.com/jerpelhan/GECO2.git
    cd GECO2

    cd /workspace/GECO2
    cp -r Deformable-DETR/models/ops models/ops

    # python deps
    micromamba run -n geco2 pip install \
        hydra-core \
        scikit-image \
        pycocotools \
        einops \
        "numpy<2" \
        gradio \
        gradio_image_prompter \
        huggingface-hub==0.34.3 \
        "pydantic<2.11"

    micromamba clean --all --yes

%runscript
    export MAMBA_ROOT_PREFIX=/opt/conda
    exec micromamba run -n geco2 "$@"
